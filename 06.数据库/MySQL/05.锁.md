# 锁

数据库锁机制简单来说，就是数据库为了保证数据的一致性，使各个共享资源再被并发访问时变得有序而设计的一种规则。

MySQL的锁机制最显著的特点是不同的存储引擎支持不同的锁机制：InnoDB支持行级锁，有时也会升级为表锁，而MyISAM只支持表锁。其中：

- 表锁的特点就是开销少、加锁快；不会出现死锁；锁粒度大，发生锁冲突的概率随之而高，并发度相对较低。
- 行锁的特点就是开销大，加锁慢；会出现死锁的情况；锁粒度小，发生锁冲突的概率低，并发度也相对表锁要高。

# InnoDB 的锁类型

InnoDB 主要有共享锁（读锁）、排他锁（写锁）、意向锁和MDL锁。

## 共享锁

共享锁，简称S锁，一个事务获取了一个数据行的读锁，其它事务能获取改行对应的读锁，但不能获取写锁（即一个事务在读取一个数据行时，其它事务也可以读，但不能对该数据进行写操作）。

共享锁有两种select方式的应用：

1. 第一种是自动提交模式下的 select 查询语句，不需要加任何锁，直接返回查询结果，这就是一致性非锁定读。
2. 第二种就是通过`select ... lock in share mode` 在被读取的行记录或行记录的范围加上一个读锁，让其他事物可以读，但是想要申请加写锁，那就会被阻塞。

## 排他锁

排他锁（写锁）简称 X 锁，一个事务获取了一个数据行的写锁，其他事务就不能再获取改行的其它锁，写锁优先级最高。

写锁的应用就比较简单了，一些 DML 语句的操作都会对行记录加写锁。比较特殊的就是 `select for update`，它会对读取的行记录加上一个写锁，那么其他任何事务就不能对被锁定的行加上任何锁了，要不然会被阻塞。

## 意向锁

InnoDB存储引擎中，意向锁是表级锁。而且有两种意向锁的类型，分别为意向共享锁和意向排他锁。

- 意向共享锁（IS）是指在给一个数据行加共享锁前必须先取得该表的IS锁。
- 意向排他锁（IX）是指在给一个数据行加排他锁前必须先取得该表的IX锁。

其实意向锁的作用跟MDL类似，都是防止在事务进行过程中，执行DDL语句的操作而导致的数据不一致。

## MDL锁

MySQL 5.5版本才有 meta data lock，简称MDL锁，用于保证表中元数据的信息。在会话A中，表开启了查询事务后，会自动获得一个MDL锁，会话B就不可以执行任何DDL语句的操作。



