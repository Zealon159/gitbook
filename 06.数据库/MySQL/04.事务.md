# 事务

事务（Transaction）是由一系列对系统中数据进行访问与更新的操作所组成的一个程序执行逻辑单元。当多个应用程序并发的访问数据库时，事务可以在这些应用程序之间提供一个隔离方法，以防止彼此的操作互相干扰。另外，事务为数据库操作序列提供了一个从失败中恢复到原始状态的方法，同时提供了数据库即使在异常状态下仍然能保持数据一致性的方法。

事务具备四个特性，原子性(Atomicity)、一致性(Consistency)、隔离性(Isolation)、持久性(Durability)，简称为事务的ACID特性。

## 原子性

事务的原子性是指，事务必须是一个原子的操作序列单元。事务中包括的各项操作在一次执行中完成，只允许以下两种结果之一：

- 全部成功执行
- 全部不执行

**即任何一项操作失败都将导致整个事务失败，同时其它已经被执行的操作都将被撤销并回滚，只有所有的操作全部成功，整个事务才算成功。**

## 一致性

事务的一致性是指，事务的执行不能破坏数据库数据的完整性和一致性，一个事务在执行之前和执行之后，数据库都必须处于一致性状态。

也就是说，数据库事务的执行结果必须是从一个一致性状态转变到另一个一致性状态，因此当数据库只包含成功事务提交结果时，就能说数据库处于一致性状态。而数据库在运行过程发生故障，有些事务尚未完成就裴坡中断，这些未完成的事务对数据库所做的修改有一部分已写入物理数据库，这时数据库就处于一种不正确的状态，也可以说是不一致的状态。

## 隔离性

事务的隔离性是指在并发环境中，并发的事务是相互隔离的，一个事务的执行不能被其它事务干扰。也就是说，不同的事务并发操纵相同的数据时，每个事务都有各自完整的数据空间，即一个事务内部的操作及使用的数据对其它并发事务是隔离的，并发执行的各个事务之间不能相互干扰。

在标准的SQL规范中，定义了4个事务隔离级别，不同的隔离级别对事务的处理不同。隔离级别对比：

| 隔离级别   | 脏读   | 可重复读 | 幻读   |
| ---------- | ------ | -------- | ------ |
| 未授权读取 | 存在   | 不可以   | 存在   |
| 授权读取   | 不存在 | 不可以   | 存在   |
| 可重复读取 | 不存在 | 可以     | 存在   |
| 串行化     | 不存在 | 可以     | 不存在 |

隔离级别越高，就越能保证数据的完整性、一致性，但同时对并发性能的影响也越大。通常情况下，优先考虑将数据库的隔离级别设置为授权读取，能够避免脏读的同时保证较好的并发性能。

以下对每种隔离级别进行详细说明。

### 隔离级别

所谓隔离级别，，就是在数据库事务中，为保证并发数据读写的正确性而提出的定义，它并不是MySQL专有的概念，而是源于 <a href="https://en.wikipedia.org/wiki/American_National_Standards_Institute" target="_blank">ANSI </a>/ <a href="https://en.wikipedia.org/wiki/International_Organization_for_Standardization" target="_blank">ISO</a>制定的<a href="https://en.wikipedia.org/wiki/SQL-92" target="_blank">SQL-92</a>标准。 每种关系型数据库都提供了各自特色的隔离级别实现，虽然在通常的定义中是以锁为实现单元，但实际的实现千差万别。以最常见的MySQL InnoDB引擎为例，它是基于 <a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-multi-versioning.html" target="_blank">MVCC</a>（Multi-Versioning Concurrency Control）和锁的复合实现，按照隔离程度从低到高，MySQL事务隔离级别分为四个不同层次： 

- 读未提交（Read uncommitted），该隔离级别允许脏读，其隔离级别最低。如果一个事务正在处理某一数据，并对其进行了更新，但同时尚未完成事务，因此还没有进行事务提交；此刻，允许另一个事务也能够访问该数据。这时候就出现了脏读现象 。
- 读已提交（Read Committed ）它和未授权读取非常接近，唯一的区别就是授权读取只允许获取已经被提交的数据。 
- 可重复读取（Repeatable Read ），简单说，就是保证再事务处理过程中，多次读取同一个数据时，其值都和事务开始的时刻是一致的。因此该事务级别禁止了不可重复读取和赃读取，但是有可能出现幻影数据。（幻影数据，就是指同样的事务操作，在前后两个时间段内执行对同一个数据项的读取，可能出现不一致的结果。） 
- 串行化（Serializable ），是最严格的事务隔离级别。它要求所有事务都被串行执行，即事务只能一个一个地进行执行，不能并发执行。 

## 持久性

事务的持久性也被称为永久性，是指一个事物一旦提交，它对数据库中对应的状态变更就应该是永久性的。

换句话说，一旦某个事务成功执行，结束后，那么它对数据库锁做的变更就必须被永久保存下来（即使发生系统崩溃或机器宕机等故障，只要数据库能够重启，那么一定能够将其恢复到事务成功结束时的状态）。